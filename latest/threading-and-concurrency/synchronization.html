<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Synchronization - Rust for Java Developers</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../ferris.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="../license.html">License</a></li><li class="chapter-item expanded affix "><a href="../contributing.html">Contributing</a></li><li class="chapter-item expanded "><a href="../getting-started/index.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../hello-world/index.html"><strong aria-hidden="true">2.</strong> Hello World</a></li><li class="chapter-item expanded "><a href="../language/index.html"><strong aria-hidden="true">3.</strong> Language Features</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../language/data-types.html"><strong aria-hidden="true">3.1.</strong> Data Types</a></li><li class="chapter-item expanded "><a href="../language/variables-and-constants.html"><strong aria-hidden="true">3.2.</strong> Variables and Constants</a></li><li class="chapter-item expanded "><a href="../language/strings.html"><strong aria-hidden="true">3.3.</strong> Strings</a></li><li class="chapter-item expanded "><a href="../language/collection-types.html"><strong aria-hidden="true">3.4.</strong> Collection Types</a></li><li class="chapter-item expanded "><a href="../language/functions.html"><strong aria-hidden="true">3.5.</strong> Functions</a></li><li class="chapter-item expanded "><a href="../language/control-flow.html"><strong aria-hidden="true">3.6.</strong> Control Flow</a></li><li class="chapter-item expanded "><a href="../language/custom-types/index.html"><strong aria-hidden="true">3.7.</strong> Custom Types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../language/custom-types/classes.html"><strong aria-hidden="true">3.7.1.</strong> Classes</a></li><li class="chapter-item expanded "><a href="../language/custom-types/records.html"><strong aria-hidden="true">3.7.2.</strong> Records</a></li><li class="chapter-item expanded "><a href="../language/custom-types/structs.html"><strong aria-hidden="true">3.7.3.</strong> Structures</a></li><li class="chapter-item expanded "><a href="../language/custom-types/interfaces-and-traits.html"><strong aria-hidden="true">3.7.4.</strong> Interfaces and Traits</a></li><li class="chapter-item expanded "><a href="../language/custom-types/enums.html"><strong aria-hidden="true">3.7.5.</strong> Enumerated Types</a></li><li class="chapter-item expanded "><a href="../language/custom-types/members.html"><strong aria-hidden="true">3.7.6.</strong> Members</a></li></ol></li><li class="chapter-item expanded "><a href="../language/lambdas-and-closures.html"><strong aria-hidden="true">3.8.</strong> Lambdas and Closures</a></li><li class="chapter-item expanded "><a href="../language/streams-and-iterators.html"><strong aria-hidden="true">3.9.</strong> Streams and Iterators</a></li><li class="chapter-item expanded "><a href="../language/pattern-matching.html"><strong aria-hidden="true">3.10.</strong> Pattern Matching</a></li><li class="chapter-item expanded "><a href="../language/packages-and-modules.html"><strong aria-hidden="true">3.11.</strong> Packages and Modules</a></li><li class="chapter-item expanded "><a href="../language/equality.html"><strong aria-hidden="true">3.12.</strong> Equality</a></li><li class="chapter-item expanded "><a href="../language/generics.html"><strong aria-hidden="true">3.13.</strong> Generics</a></li><li class="chapter-item expanded "><a href="../language/polymorphism.html"><strong aria-hidden="true">3.14.</strong> Polymorphism</a></li><li class="chapter-item expanded "><a href="../language/inheritance.html"><strong aria-hidden="true">3.15.</strong> Inheritance</a></li><li class="chapter-item expanded "><a href="../language/error-handling.html"><strong aria-hidden="true">3.16.</strong> Error Handling</a></li><li class="chapter-item expanded "><a href="../language/nullability-and-optionality.html"><strong aria-hidden="true">3.17.</strong> Nullability and Optionality</a></li><li class="chapter-item expanded "><a href="../language/conversion-and-casting.html"><strong aria-hidden="true">3.18.</strong> Conversion and Casting</a></li><li class="chapter-item expanded "><a href="../language/annotations.html"><strong aria-hidden="true">3.19.</strong> Annotations</a></li><li class="chapter-item expanded "><a href="../language/smart-pointers.html"><strong aria-hidden="true">3.20.</strong> Smart Pointers</a></li><li class="chapter-item expanded "><a href="../language/documentation-comments.html"><strong aria-hidden="true">3.21.</strong> Documentation Comments</a></li></ol></li><li class="chapter-item expanded "><a href="../memory-management/index.html"><strong aria-hidden="true">4.</strong> Memory Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../memory-management/ownership.html"><strong aria-hidden="true">4.1.</strong> Ownership</a></li><li class="chapter-item expanded "><a href="../memory-management/references-and-lifetimes.html"><strong aria-hidden="true">4.2.</strong> References and Lifetimes</a></li></ol></li><li class="chapter-item expanded "><a href="../resource-management/index.html"><strong aria-hidden="true">5.</strong> Resource Management</a></li><li class="chapter-item expanded "><a href="../threading-and-concurrency/index.html"><strong aria-hidden="true">6.</strong> Threading and Concurrency</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../threading-and-concurrency/threads.html"><strong aria-hidden="true">6.1.</strong> Threads</a></li><li class="chapter-item expanded "><a href="../threading-and-concurrency/synchronization.html" class="active"><strong aria-hidden="true">6.2.</strong> Synchronization</a></li><li class="chapter-item expanded "><a href="../threading-and-concurrency/producer-consumer.html"><strong aria-hidden="true">6.3.</strong> Producer-Consumer Pattern</a></li></ol></li><li class="chapter-item expanded "><a href="../testing/index.html"><strong aria-hidden="true">7.</strong> Testing</a></li><li class="chapter-item expanded "><a href="../benchmarking/index.html"><strong aria-hidden="true">8.</strong> Benchmarking</a></li><li class="chapter-item expanded "><a href="../logging-and-tracing/index.html"><strong aria-hidden="true">9.</strong> Logging and Tracing</a></li><li class="chapter-item expanded "><a href="../environment-and-configuration/index.html"><strong aria-hidden="true">10.</strong> Environment and Configuration</a></li><li class="chapter-item expanded "><a href="../build-tools/index.html"><strong aria-hidden="true">11.</strong> Build Tools</a></li><li class="chapter-item expanded "><a href="../project-structure/index.html"><strong aria-hidden="true">12.</strong> Project Structure</a></li><li class="chapter-item expanded "><a href="../meta-programming/index.html"><strong aria-hidden="true">13.</strong> Meta Programming</a></li><li class="chapter-item expanded "><a href="../asynchronous-programming/index.html"><strong aria-hidden="true">14.</strong> Asynchronous Programming</a></li><li class="chapter-item expanded affix "><a href="../next-steps.html">Next Steps</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust for Java Developers</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/chrischiedo/rust-for-java-devs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/chrischiedo/rust-for-java-devs/edit/main/src/threading-and-concurrency/synchronization.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="synchronization"><a class="header" href="#synchronization">Synchronization</a></h1>
<p>When data is shared between threads, one needs to synchronize read-write
access to the data in order to avoid corruption. Java offers the <code>synchronized</code>
keyword as a synchronization primitive. When we use a synchronized block, Java internally uses a <a href="https://en.wikipedia.org/wiki/Monitor_(synchronization)">monitor</a>, also known as a <em>monitor lock</em> to provide synchronization:</p>
<pre><code class="language-java">public class ExampleClass {

    static int data = 0;

    public static void main(String[] args) throws InterruptedException {

        var dataLock = new Object(); // declare a monitor lock object

        var threads = new ArrayList&lt;Thread&gt;();

        for (var i = 0; i &lt; 10; i++) {
            var thread =  new Thread(() -&gt; {
                for (var j = 0; j &lt; 1000; j++) {
                    synchronized (dataLock) {
                        data++;
                    }
                }
            });

            threads.add(thread);
            thread.start();
        }

        for (var thread : threads) {
            thread.join();
        }

        System.out.println(data); // prints: 10000
    }
}
</code></pre>
<p>In Rust, one must make explicit use of concurrency structures like <code>Mutex</code>:</p>
<pre><code class="language-rust">use std::thread;
use std::sync::{Arc, Mutex};

fn main() {
    let data = Arc::new(Mutex::new(0)); // (1)

    let mut threads = vec![];
    for _ in 0..10 {
        let data = Arc::clone(&amp;data); // (2)
        let thread = thread::spawn(move || { // (3)
            for _ in 0..1000 {
                let mut data = data.lock().unwrap();
                *data += 1; // (4)
            }
        });
        threads.push(thread);
    }

    for thread in threads {
        thread.join().unwrap();
    }

    println!(&quot;{}&quot;, data.lock().unwrap()); // prints: 10000
}</code></pre>
<p>A few things to note:</p>
<ul>
<li>
<p>Since the ownership of the <code>Mutex</code> instance and in turn the data it guards
will be shared by multiple threads, it is wrapped in an <code>Arc</code> (1). <code>Arc</code>
provides <em>atomic reference counting</em>, which increments each time it is cloned
(2) and decrements each time it is dropped. When the count reaches zero, the
mutex and in turn the data it guards are dropped.</p>
</li>
<li>
<p>The closure instance for each thread receives ownership (3) of the <em>cloned
reference</em> (2).</p>
</li>
<li>
<p>The <code>move</code> keyword (3) is <em>required</em> to <em>move</em> or pass the ownership of <code>data</code> (2) to 
the closure for the thread.</p>
</li>
<li>
<p>The pointer-like code that is <code>*data += 1</code> (4), is not some unsafe pointer
access even if it looks like it. It's updating the data <em>wrapped</em> in the
<a href="https://doc.rust-lang.org/stable/std/sync/struct.MutexGuard.html">mutex guard</a>.</p>
</li>
</ul>
<p>Unlike the Java version, where one can render it <em>thread-unsafe</em> by commenting out
the <code>synchronized</code> statement, the Rust version will refuse to compile if it's changed
in any way (e.g. by commenting out parts that renders it thread-unsafe). This
demonstrates that writing thread-safe code is the developer's responsibility
in Java, by careful use of synchronized structures, whereas in Rust, one
can rely on the compiler to enforce <em>thread-safety</em>.</p>
<p>The compiler is able to help because data structures in Rust are marked by
special traits: <code>Sync</code> and <code>Send</code>. <a href="https://doc.rust-lang.org/stable/std/marker/trait.Sync.html"><code>Sync</code></a> indicates that references to a type's instances are safe to share between threads. <a href="https://doc.rust-lang.org/stable/std/marker/trait.Send.html"><code>Send</code></a> indicates that it's safe to send instances of a type across thread boundaries. For more information, see the “<a href="https://doc.rust-lang.org/book/ch16-00-concurrency.html">Fearless Concurrency</a>” chapter of the Rust book.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../threading-and-concurrency/threads.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../threading-and-concurrency/producer-consumer.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../threading-and-concurrency/threads.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../threading-and-concurrency/producer-consumer.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../ferris.js"></script>


    </body>
</html>
